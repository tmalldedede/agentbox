openapi: 3.0.3
info:
  title: AgentBox API
  description: |
    AgentBox - 开源的 AI Agent 容器化运行平台 API 文档。

    为 AI Agent 提供安全、隔离、可管理的执行环境。支持 Claude Code、Codex 等主流 Agent。
  version: 0.1.0
  license:
    name: Apache-2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  contact:
    name: AgentBox
    url: https://github.com/tmalldedede/agentbox

servers:
  - url: http://localhost:8080
    description: 本地开发服务器

tags:
  - name: System
    description: 系统相关接口
  - name: Agents
    description: Agent 管理
  - name: Sessions
    description: 会话管理
  - name: Executions
    description: 任务执行
  - name: Files
    description: 文件管理
  - name: Stream
    description: WebSocket 实时流

paths:
  /health:
    get:
      tags:
        - System
      summary: 健康检查
      description: 检查服务是否正常运行
      operationId: healthCheck
      responses:
        '200':
          description: 服务正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/v1/agents:
    get:
      tags:
        - Agents
      summary: 列出支持的 Agent
      description: 获取所有可用的 Agent 类型列表
      operationId: listAgents
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentListResponse'

  /api/v1/sessions:
    post:
      tags:
        - Sessions
      summary: 创建会话
      description: 创建新的 Agent 会话，会自动创建并启动容器
      operationId: createSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags:
        - Sessions
      summary: 列出会话
      description: 获取所有会话列表，支持分页和过滤
      operationId: listSessions
      parameters:
        - name: agent
          in: query
          description: 按 Agent 类型过滤
          schema:
            type: string
            example: claude-code
        - name: status
          in: query
          description: 按状态过滤
          schema:
            $ref: '#/components/schemas/SessionStatus'
        - name: limit
          in: query
          description: 返回数量限制
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: 偏移量
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'

  /api/v1/sessions/{id}:
    get:
      tags:
        - Sessions
      summary: 获取会话详情
      description: 根据 ID 获取会话详细信息
      operationId: getSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Sessions
      summary: 删除会话
      description: 删除会话及其关联的容器
      operationId: deleteSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/start:
    post:
      tags:
        - Sessions
      summary: 启动会话
      description: 启动已停止的会话容器
      operationId: startSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 启动成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/stop:
    post:
      tags:
        - Sessions
      summary: 停止会话
      description: 停止正在运行的会话容器
      operationId: stopSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 停止成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/reconnect:
    post:
      tags:
        - Sessions
      summary: 重连会话
      description: |
        重新连接到已存在的会话。

        - 如果会话正在运行，直接返回会话信息
        - 如果会话已停止，尝试重新启动容器
        - 如果容器不存在或无法启动，返回错误
      operationId: reconnectSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 重连成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 重连失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/exec:
    post:
      tags:
        - Executions
      summary: 执行任务
      description: 在会话中执行 Agent 任务
      operationId: execSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecRequest'
      responses:
        '200':
          description: 执行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecResultResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/executions:
    get:
      tags:
        - Executions
      summary: 获取执行历史
      description: 获取会话的所有执行记录
      operationId: getExecutions
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionListResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/executions/{execId}:
    get:
      tags:
        - Executions
      summary: 获取执行详情
      description: 获取单个执行记录的详细信息
      operationId: getExecution
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - $ref: '#/components/parameters/ExecutionId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '404':
          description: 执行记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/logs:
    get:
      tags:
        - Sessions
      summary: 获取容器日志
      description: 获取会话容器的运行日志
      operationId: getSessionLogs
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 文件管理
  /api/v1/sessions/{id}/files:
    get:
      tags:
        - Files
      summary: 列出文件
      description: 列出会话工作空间中的文件和目录
      operationId: listFiles
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: path
          in: query
          description: 相对路径，默认为根目录
          schema:
            type: string
            default: ""
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileListResponse'
        '404':
          description: 会话或路径不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Files
      summary: 上传文件
      description: 上传文件到会话工作空间
      operationId: uploadFile
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: 要上传的文件
                path:
                  type: string
                  description: 目标路径（相对于工作空间）
                  default: ""
              required:
                - file
      responses:
        '200':
          description: 上传成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUploadResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/files/{path}:
    get:
      tags:
        - Files
      summary: 下载/读取文件
      description: 下载文件内容或读取文本文件内容
      operationId: downloadFile
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: path
          in: path
          required: true
          description: 文件路径（相对于工作空间）
          schema:
            type: string
        - name: content
          in: query
          description: 如果为 true，返回文本内容而非下载
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: 成功
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                $ref: '#/components/schemas/FileContentResponse'
        '404':
          description: 文件不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Files
      summary: 删除文件或目录
      description: 删除指定的文件或目录
      operationId: deleteFile
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: path
          in: path
          required: true
          description: 文件或目录路径（相对于工作空间）
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileDeleteResponse'
        '404':
          description: 文件不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/sessions/{id}/directories:
    post:
      tags:
        - Files
      summary: 创建目录
      description: 在会话工作空间中创建目录
      operationId: createDirectory
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                path:
                  type: string
                  description: 目录路径（相对于工作空间）
                  example: "src/components"
              required:
                - path
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectoryCreateResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # WebSocket 流式执行
  /api/v1/sessions/{id}/stream:
    get:
      tags:
        - Stream
      summary: WebSocket 流式执行
      description: |
        通过 WebSocket 连接进行流式执行任务。

        ## 连接流程
        1. 客户端建立 WebSocket 连接
        2. 客户端发送执行请求 (JSON)
        3. 服务端流式返回执行输出
        4. 执行完成后服务端发送 done 消息

        ## 消息格式
        所有消息都是 JSON 格式：
        ```json
        {
          "type": "message|error|done|ping|start",
          "content": "输出内容",
          "timestamp": 1234567890123,
          "execution_id": "e1f2g3h4"
        }
        ```

        ## 消息类型
        - `start`: 执行开始，包含 execution_id
        - `message`: 输出消息
        - `error`: 错误消息
        - `done`: 执行完成
        - `ping`: 心跳消息（每30秒）
      operationId: execStream
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '101':
          description: WebSocket 升级成功
        '400':
          description: WebSocket 升级失败
        '404':
          description: 会话不存在

components:
  parameters:
    SessionId:
      name: id
      in: path
      required: true
      description: 会话 ID
      schema:
        type: string
        example: "a1b2c3d4"

    ExecutionId:
      name: execId
      in: path
      required: true
      description: 执行记录 ID
      schema:
        type: string
        example: "e1f2g3h4"

  schemas:
    # 基础响应
    Response:
      type: object
      properties:
        code:
          type: integer
          description: 状态码，0 表示成功
          example: 0
        message:
          type: string
          description: 状态信息
          example: success
      required:
        - code
        - message

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          example:
            code: 404
            message: "session not found: abc123"

    # 分页
    Pagination:
      type: object
      properties:
        total:
          type: integer
          description: 总数量
          example: 100
        limit:
          type: integer
          description: 每页数量
          example: 20
        offset:
          type: integer
          description: 偏移量
          example: 0

    # Health
    HealthResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                status:
                  type: string
                  example: ok
                version:
                  type: string
                  example: "0.1.0"

    # Agent
    Agent:
      type: object
      properties:
        name:
          type: string
          description: Agent 标识符
          example: claude-code
        display_name:
          type: string
          description: 显示名称
          example: Claude Code
        description:
          type: string
          description: Agent 描述
          example: Anthropic Claude Code CLI agent
        image:
          type: string
          description: Docker 镜像
          example: agentbox/agent:latest
        required_env:
          type: array
          description: 必需的环境变量
          items:
            type: string
          example: ["ANTHROPIC_API_KEY"]
      required:
        - name
        - display_name
        - image
        - required_env

    AgentListResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Agent'

    # Session
    SessionStatus:
      type: string
      enum:
        - creating
        - running
        - stopped
        - error
      description: 会话状态

    SessionConfig:
      type: object
      properties:
        cpu_limit:
          type: number
          format: float
          description: CPU 核心数限制
          example: 2.0
        memory_limit:
          type: integer
          format: int64
          description: 内存限制（字节）
          example: 4294967296

    Session:
      type: object
      properties:
        id:
          type: string
          description: 会话 ID
          example: "a1b2c3d4"
        agent:
          type: string
          description: Agent 类型
          example: claude-code
        status:
          $ref: '#/components/schemas/SessionStatus'
        workspace:
          type: string
          description: 工作空间路径
          example: /tmp/agentbox/workspaces/myproject
        container_id:
          type: string
          description: Docker 容器 ID
          example: "abc123def456"
        config:
          $ref: '#/components/schemas/SessionConfig'
        env:
          type: object
          additionalProperties:
            type: string
          description: 环境变量（敏感值会被隐藏）
        created_at:
          type: string
          format: date-time
          description: 创建时间
        updated_at:
          type: string
          format: date-time
          description: 更新时间
      required:
        - id
        - agent
        - status
        - workspace
        - config
        - created_at
        - updated_at

    CreateSessionRequest:
      type: object
      properties:
        agent:
          type: string
          description: Agent 类型
          example: claude-code
        workspace:
          type: string
          description: 工作空间路径（绝对路径或相对于 workspace_base）
          example: /path/to/project
        env:
          type: object
          additionalProperties:
            type: string
          description: 环境变量
          example:
            ANTHROPIC_API_KEY: "sk-ant-xxx"
        config:
          $ref: '#/components/schemas/SessionConfig'
      required:
        - agent
        - workspace

    SessionResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Session'

    SessionListResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Session'
            pagination:
              $ref: '#/components/schemas/Pagination'

    DeleteResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                deleted:
                  type: string
                  description: 已删除的会话 ID
                  example: "a1b2c3d4"

    LogsResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                logs:
                  type: string
                  description: 容器日志内容
                  example: "Starting agent...\nReady to accept commands."

    # Execution
    ExecutionStatus:
      type: string
      enum:
        - pending
        - running
        - success
        - failed
      description: 执行状态

    Execution:
      type: object
      properties:
        id:
          type: string
          description: 执行记录 ID
          example: "e1f2g3h4"
        session_id:
          type: string
          description: 所属会话 ID
          example: "a1b2c3d4"
        prompt:
          type: string
          description: 执行的提示/命令
          example: "帮我写一个 hello world 程序"
        status:
          $ref: '#/components/schemas/ExecutionStatus'
        output:
          type: string
          description: 执行输出
          example: "已创建 hello.py 文件..."
        error:
          type: string
          description: 错误信息
        exit_code:
          type: integer
          description: 退出码
          example: 0
        started_at:
          type: string
          format: date-time
          description: 开始时间
        ended_at:
          type: string
          format: date-time
          description: 结束时间
      required:
        - id
        - session_id
        - prompt
        - status
        - exit_code
        - started_at

    ExecRequest:
      type: object
      properties:
        prompt:
          type: string
          description: 要执行的提示/命令
          example: "帮我写一个 hello world 程序"
        max_turns:
          type: integer
          description: 最大对话轮数
          minimum: 1
          maximum: 100
          default: 10
          example: 10
        timeout:
          type: integer
          description: 超时时间（秒）
          minimum: 10
          maximum: 3600
          default: 300
          example: 300
        allowed_tools:
          type: array
          description: 允许使用的工具列表
          items:
            type: string
          example: ["Read", "Write", "Bash"]
        disallowed_tools:
          type: array
          description: 禁止使用的工具列表
          items:
            type: string
          example: ["WebFetch"]
      required:
        - prompt

    ExecResult:
      type: object
      properties:
        execution_id:
          type: string
          description: 执行记录 ID
          example: "e1f2g3h4"
        output:
          type: string
          description: 执行输出
          example: "已创建 hello.py 文件..."
        exit_code:
          type: integer
          description: 退出码
          example: 0
        error:
          type: string
          description: 错误信息

    ExecResultResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/ExecResult'

    ExecutionResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/Execution'

    ExecutionListResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Execution'

    # 文件管理
    FileType:
      type: string
      enum:
        - file
        - directory
      description: 文件类型

    FileInfo:
      type: object
      properties:
        name:
          type: string
          description: 文件名
          example: "main.go"
        path:
          type: string
          description: 相对路径
          example: "src/main.go"
        type:
          $ref: '#/components/schemas/FileType'
        size:
          type: integer
          format: int64
          description: 文件大小（字节），仅文件类型有效
          example: 1024
        modified_at:
          type: string
          format: date-time
          description: 修改时间
        children_count:
          type: integer
          description: 子项数量，仅目录类型有效
          example: 5
      required:
        - name
        - path
        - type

    FileListResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                path:
                  type: string
                  description: 当前路径
                  example: "src"
                files:
                  type: array
                  items:
                    $ref: '#/components/schemas/FileInfo'

    FileContentResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                path:
                  type: string
                  description: 文件路径
                  example: "src/main.go"
                content:
                  type: string
                  description: 文件内容
                  example: "package main\n\nfunc main() {\n\tfmt.Println(\"Hello\")\n}"
                size:
                  type: integer
                  format: int64
                  description: 文件大小（字节）
                  example: 56
                encoding:
                  type: string
                  description: 编码
                  example: "utf-8"

    FileUploadResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                path:
                  type: string
                  description: 上传后的文件路径
                  example: "uploads/image.png"
                size:
                  type: integer
                  format: int64
                  description: 文件大小（字节）
                  example: 2048

    FileDeleteResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                deleted:
                  type: string
                  description: 已删除的文件路径
                  example: "src/old_file.go"

    DirectoryCreateResponse:
      allOf:
        - $ref: '#/components/schemas/Response'
        - type: object
          properties:
            data:
              type: object
              properties:
                path:
                  type: string
                  description: 创建的目录路径
                  example: "src/components"

    # WebSocket 相关
    StreamExecRequest:
      type: object
      description: WebSocket 流式执行请求（客户端发送）
      properties:
        prompt:
          type: string
          description: 要执行的提示/命令
          example: "帮我写一个 hello world 程序"
        max_turns:
          type: integer
          description: 最大对话轮数
          minimum: 1
          maximum: 100
          default: 10
        timeout:
          type: integer
          description: 超时时间（秒）
          minimum: 10
          maximum: 3600
          default: 300
        allowed_tools:
          type: array
          description: 允许使用的工具列表
          items:
            type: string
        disallowed_tools:
          type: array
          description: 禁止使用的工具列表
          items:
            type: string
      required:
        - prompt

    StreamMessage:
      type: object
      description: WebSocket 流式消息（服务端返回）
      properties:
        type:
          type: string
          enum:
            - start
            - message
            - error
            - done
            - ping
          description: 消息类型
        content:
          type: string
          description: 消息内容
        timestamp:
          type: integer
          format: int64
          description: 时间戳（毫秒）
        execution_id:
          type: string
          description: 执行 ID（仅 start/done 类型有）
      required:
        - type
        - timestamp
